import nmap

def nmap_scan(ip_address, comprehensive=False):
    nm = nmap.PortScanner()

    # Choose scan type based on user selection
    if comprehensive:
        scan_command = "-sV -T4 -O --version-light"
    else:
        scan_command = "-sV -T4 -O -F --version-light"

    # Run the scan
    nm.scan(ip_address, arguments=scan_command)
    
    # Initialize data structure
    os = nm[ip_address]['osmatch'][0]['name'] if 'osmatch' in nm[ip_address] and len(nm[ip_address]['osmatch']) > 0 else 'Unknown'
    ports = []
    protocols = []
    services = []
    versions = []

    # Extract details for each open port
    for proto in nm[ip_address].all_protocols():
        for port in nm[ip_address][proto]:
            ports.append(str(port))
            protocols.append(proto)
            service = nm[ip_address][proto][port].get('name', 'Unknown')
            services.append(service)
            version = nm[ip_address][proto][port].get('version', 'Unknown')
            versions.append(version)
    
    return {
        'os': os,
        'ports': ','.join(ports),
        'protocols': ','.join(protocols),
        'services': ','.join(services),
        'versions': ','.join(versions)
    }
